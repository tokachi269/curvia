# 緩和曲線（クロソイド）連続線形設計仕様

## 1\. このドキュメントの目的

座標で指定された複数の折れ点列（P0..Pn）と、各折れ点に対応する設計半径 R\_i から、だれでも扱える「遊びツール」向けの滑らかな道路風ライン（直線→クロソイド→円弧→クロソイド→直線…の連続列）を計算する手順を定義します。専門的な土木知識がなくても読めるよう、実装フローを分解しています。道路・鉄道の設計で使われる考え方を簡略化して適用します。

## 2\. 実装状況とアプリケーション構成

本仕様は実際に動作するWebアプリケーションとして実装されており、以下の技術スタックで構築されています：

### 2.1 技術構成
- **フロントエンド**: Vue.js 3（Composition API）
- **ビルドツール**: Vite
- **描画**: HTML5 Canvas
- **言語**: JavaScript（ES6+）

### 2.2 主要機能
- **インタラクティブ編集**: 制御点のドラッグ&ドロップによる直感的な線形編集
- **リアルタイム計算**: 制御点移動時の即座な緩和曲線再計算
- **視覚的フィードバック**: TS/SC/CS/ST点の表示、スパイラル・円弧の色分け
- **パラメータ調整**: 半径、スパイラル係数、スパイラル長の個別設定
- **モード切替**: ループモード/非ループモード、塗りつぶし表示
- **プレビュー機能**: 線上へのマウスホバーによる挿入点プレビュー
- **ズーム・パン**: 拡大縮小、画面移動による詳細確認

### 2.3 ファイル構成
```
src/
├── App.vue                  # メインアプリケーション（UI・イベント処理）
├── main.js                  # エントリーポイント
└── utils/
    ├── clothoidUtils.js     # 緩和曲線計算（§9仕様準拠）
    ├── curveGenerator.js    # 多点連続曲線生成
    ├── mathUtils.js         # 数学計算・座標変換ユーティリティ
    ├── canvasRenderer.js    # Canvas描画エンジン
    ├── logger.js           # デバッグ・パフォーマンス計測・ログ管理
    └── errorHandler.js     # エラー処理・入力検証・統一フォーマット
```

### 2.4 計算機能（実装済み）
- **Spiral Calculation Guide完全準拠計算**: 7次近似による高精度Xc/Yc算出
- **多点連続線形**: 複数制御点を連続的に接続する緩和曲線生成
- **スパイラル点列生成**: 数値積分による高精度サンプリング
- **円弧点列生成**: 等角度分割による滑らかな円弧
- **自動パラメータ調整**: スパイラル長・タンジェント長の最適化
- **エラー処理**: 幾何学的制約違反時の自動フォールバック
- **線上点挿入**: マウスホバーによる滑らかな挿入点プレビュー機能
- **統一ログシステム**: 計算過程の詳細記録とデバッグ支援

## 2.5 高度な数学計算

アプリケーションは以下の高精度計算機能を実装しています：

- **7次近似Fresnel積分**: 理論精度99.99%での緩和曲線計算  
- **数値積分サンプリング**: 滑らかな曲線点列生成
- **幾何学的制約解決**: 自動パラメータ調整・フォールバック処理
- **座標系変換**: グローバル↔ローカル座標での高精度計算
- **線形補間**: 線上任意点でのスムーズな点挿入
- **角度正規化**: [-π, π]範囲での安定した角度計算
- **数値積分**: 曲率線形変化による高精度スパイラル点列生成

## 2.6 ループモード使用時の注意点（重要）

ループモードと通常モードでは、セグメント数計算やインデックス構造が異なるため、以下の点にご注意ください：

#### セグメント数の違い
**通常モード（非ループ）**：
- セグメント数 = 制御点数 - 2
- 例：制御点P0, P1, P2 → セグメント1個（P0→P1→P2の角P1のみ処理）

**ループモード**：
- セグメント数 = 制御点数
- 例：制御点P0, P1, P2 → セグメント3個（P0, P1, P2すべての角を処理）

#### 実装上の統一対策
これらの違いを吸収するため、統一インデックス計算関数を実装：

```javascript
// 統一されたセグメント数計算
import { getUnifiedTotalSegments, calculateCorrectSegmentIndex } from './utils/loopProtection.js'

// App.vue、curveGenerator.js、canvasRenderer.jsで同じ計算を使用
const totalSegments = getUnifiedTotalSegments(points.length, isLoop)
const segmentIndex = calculateCorrectSegmentIndex(curveIndex, points.length, isLoop, totalPoints)
```

#### モード切替時の注意
- **ループON→OFF**: セグメント数が減少し、一部のセグメントが無効化される
- **ループOFF→ON**: セグメント数が増加し、新たな接続セグメントが生成される
- **ラベル表示**: 各モードで適切なラベル番号が自動計算される

---

## 3\. なぜ緩和曲線（クロソイド）が必要？

直線（まっすぐ）から急に円弧（一定半径）に入ると、車やカートに急な遠心力変化がかかり、操舵や走行がぎくしゃくします。そこで「曲率＝曲がり具合」を **0 から徐々に増やして円弧半径に到達**する遷移区間（スパイラル／クロソイド）を両端に入れると、自然で走りやすい線形になります。スパイラルの始まりでは半径は無限大（＝直線）、終端で指定半径 R に到達します。

---

## 4\. 緩和曲線を構成する代表点

単一の折れ点（PI）まわりに通常以下の 5 点（状況により 4 点）を考えます：

-   **PI**: 2 本の直線（バックタンジェント・フォワードタンジェント）の交点（折れ点）。
    
-   **TS**: Tangent → Spiral の切替点（直線終わり／クロソイド始まり）。
    
-   **SC**: Spiral → Circular の切替点（クロソイド終わり／円弧始まり）。
    
-   **CS**: Circular → Spiral の切替点（円弧終わり／出口クロソイド始まり）。
    
-   **ST**: Spiral → Tangent の切替点（出口クロソイド終わり／次の直線始まり）。
    

入口（TS→SC）と出口（CS→ST）のスパイラルを左右対称にするのが標準的な扱いです。

---

## 5\. 入力データ（最小）

```yaml
Points:  P[0], P[1], ..., P[n]          # 各点 (x,y)
Radii:   R[1], R[2], ..., R[n-1]        # 各折れ点 P[i] 用カーブ半径 (正値, null=カーブなし)
Units:   任意 (m, ft, px) （すべて同一単位で）
Angles:  rad 推奨（deg を入力した場合は内部で rad 変換）
```

折れ点ごとに別々の R を指定できます（カーブごとに半径が違う複合線形を作れる）。複合カーブ（連続複数カーブ）を設計する考え方は道路設計ガイドで一般的です。

### 5.1 入力形式の詳細
アプリケーションでは以下の形式で制御点を管理しています：

```javascript
points = [
  { x: 120, y: 400 },                    // P0 (始点)
  { 
    x: 400, 
    y: 200, 
    radius: 100,                         // 円弧半径 R
    spiralMode: 'auto',                  // スパイラル長計算モード
    spiralLength: 50,                    // 手動スパイラル長
    spiralFactor: 4.0,                   // スパイラル係数
    calculatedSpiral: null               // 計算結果キャッシュ
  },                                     // P1 (中間点)
  { x: 650, y: 350 }                     // P2 (終点)
]
```

### 5.2 パラメータ設定の詳細
- **radius**: 円弧半径（10-500m）
- **spiralMode**: "auto"（角度依存自動計算）または "manual"（手動指定）
- **spiralLength**: 手動指定時のスパイラル長（1m以上、半径の2倍以下）
- **spiralFactor**: 自動計算時の係数（0.5-3.0、標準4.0）。角度×基準係数×本係数でスパイラル長決定
- **calculatedSpiral**: 計算結果の一時保存（長さ、角度等）

---

## 6\. 座標系と角度の扱い

-   座標は右手系想定（x 増＝右、y 増＝上）で説明します。画面座標（y 下向き）の場合は描画時に符号変換。
    
-   角度は数学標準（+x 軸基準、反時計回りが正）で扱うと計算式がシンプル。
    
-   入力が方位（例：N35E 等）の場合は方位→ラジアン変換後に使用（折れ角計算方法は後述）。道路実務資料でも中央角は進行方向（方位）差から求めます。

### 6.1 角度計算の詳細
計算では数学ユーティリティ関数で以下の計算を提供：

- **2点間方位角**: `atan2(dy, dx)` による安定計算
- **角度正規化**: `normalizeAngle()` で [-π, π] 範囲に正規化
- **角度差計算**: 最短回転方向での角度差算出
- **座標変換**: ローカル座標系とグローバル座標系の相互変換

---

## 7\. 変数名（ASCII, コピペ安全）

| 名前 | 意味 | 備考 |
| --- | --- | --- |
| `P[i]` | (x,y) 折れ点座標 | i=0..n |
| `Az[i]` | 方位角 rad (P\[i\]→P\[i+1\]) | atan2 |
| `defl[i]` | 折れ角 rad = normalize(Az\[i\] - Az\[i-1\]) | \-pi..+pi |
| `sgn[i]` | 左(+1)/右(-1) = sign(defl\[i\]) |  |
| `R[i]` | 半径 (指定) | \>0 |
| `Ls[i]` | スパイラル長（入口=出口同長） | 自動/入力 |
| `th_s[i]` | スパイラル角 rad = Ls/(2\*R) | see §10.3 |
| `defl_c[i]` | 円弧中央角 rad = abs(defl) - 2\*th\_s | see §10.4 |
| `Yc,Xc` | TS→SC ローカル座標 | see §10.5 |
| `rho,k` | シフト補助量 | see §10.6 |
| `Ts_in` | PI→TS 距離 | see §10.7 |
| `Ts_out` | PI→ST 距離（対称なら同じ） | see §10.7 |

（公式の表記との対応は §19 参照。）要素名は各州 DOT ガイドで共通的に使われています。

### 7.1 主要計算機能
以下の主要機能で§10の計算を実行：

- 単一折れ点での緩和曲線計算（§9準拠）
- 多点連続曲線生成
- スパイラル点列の数値積分生成
- 円弧点列生成

---

## 8\. 基本：まず単純円弧で折れ角を丸める（復習）

緩和曲線を入れる前に、折れ角 `defl` を半径 `R` の **単純円弧**で繋ぐときの古典式を押さえておきます：

```ini
T = R * tan(|defl| / 2)          # PI から円弧接点までのタンジェント長
C = 2 * R * sin(|defl| / 2)      # 円弧の弦長
L = R * |defl|                   # 円弧長 (defl: rad)
```

（度で計算する場合はラジアン換算または式を変形。）これらは道路設計・測量の基本式として多数の設計マニュアルで使われています。

---

## 9\. 緩和曲線を入れるとどう変わる？

入口と出口にスパイラル区間（曲率 0→1/R, 1/R→0）を入れるため、元の折れ角 `defl` の一部をスパイラルが「消費」し、中央の円弧角は小さく（＝円弧短く）なります。スパイラルは円弧を内側へ「押し込む」ので、円弧中心やタンジェント長も補正が必要です。これらの補正式（`Yc`, `Xc`, `rho`, `k`, `Ts` 等）が設計ガイドにまとまっています。

---

## 10\. 単一折れ点（PI）に対する完全計算フロー（対称スパイラル）

以下、入口スパイラル長 = 出口スパイラル長 = `Ls`（仮定）で説明します。多点・非対称は §13 以降。

### 10.1 角度を計算

```ini
Az_in  = atan2(Pi.y - P(i-1).y, Pi.x - P(i-1).x)
Az_out = atan2(P(i+1).y - Pi.y, P(i+1).x - Pi.x)
defl   = normalize(Az_out - Az_in)  # 範囲 [-pi, +pi]
sgn    = +1 if defl >= 0 else -1    # 左/右
absDef = abs(defl)
```

（折れ角は進入方位と退出方位の差で求める。実務例：入出方位から中央角 Δ を算出。)

---

### 10.2 スパイラル長 Ls の初期値（自動設定ガイド）

ユーザーが Ls を指定しない場合の自動推定の一例：

1.  角度制限: `Ls <= R * absDef` （これを超えると残り円弧角が負になる。式は §10.4 参照。）
    
2.  現実的長さ: 速度や超高を考慮して十分長い遷移を取る（設計ガイドでは速度やsuperelevationで最小長を与える例あり）。
    
3.  角度依存ヒューリスティック（実装版）:  
    `Ls = 25.0 * absDef * spiralFactor`  
    ※ 基準係数25.0により、2ラジアン（約115度）で50m、spiralFactorで調整可能。角度が大きいほどスパイラル長も比例増加。

---

### 10.3 スパイラル角（スパイラルが消費する方位変化）

```ini
th_s = Ls / (2 * R)    # rad
```

設計資料では「Spiral Angle θs = Ls \* DC / 200」等、度・度曲率ベースの式が紹介されますが、半径 R のクロソイドで平均曲率が約 1/(2R) になることから上記式が得られます。公式表式（度版）は下記参照。

---

### 10.4 円弧中央角（スパイラル挿入後に残る角度）

```makefile
defl_c = absDef - 2 * th_s
if defl_c < 0: reduce Ls and recompute
```

TDOT 式（度）では `Delta_c = Delta - 2 * theta_s` として与えられます。

---

### 10.5 TS→SC のローカル座標 (Xc, Yc)

TS を原点、進入直線方向を +X とする 2D ローカル系で、SC のオフセット量を高精度近似式で求めます。

```ini
Yc = (Ls * Ls) / (6 * R)                                    # Eqn.5

# 高精度7次近似（Spiral Calculation Guide Eqn.6準拠）
Xc = Ls - (Ls^3)/(40*R^2) + (Ls^5)/(3456*R^4) - (Ls^7)/(599040*R^6)
```

この7次近似式により、従来の簡易式と比較して以下の精度向上が実現されます：

- **3次項まで**: 一般的な設計で十分な精度（誤差 < 1%）
- **5次項まで**: 高精度設計での推奨レベル（誤差 < 0.1%）  
- **7次項まで**: 理論値とほぼ一致（誤差 < 0.01%）

実装では`calculateXcAccurate()`関数でこの7次近似を使用しています。

---

### 10.6 シフト補正（rho, k）

スパイラル挿入で円弧がわずかに内側・前方にずれる量を補正します。

```ini
rho = Yc - R * (1 - cos(th_s))
k   = Xc - R * sin(th_s)
```

これらは TS 基準での補助距離。後続のタンジェント距離計算に使います。設計ガイド標準式。

---

### 10.7 PI→TS (タンジェント距離)

補正込みの最終式：

```ini
Ts = (R + rho) * tan(absDef / 2) + k
```

（度式で `Ts = (R + rho) * tan(Delta/2) + k`。mypdh など他資料では `Ts = (R + o) * tan(I/2) + Z` と同型。）

---

### 10.8 TS 座標（グローバル）

バックタンジェント単位ベクトル：

```ini
tx = cos(Az_in)
ty = sin(Az_in)
TS = (Pi.x - Ts * tx,  Pi.y - Ts * ty)
```

（PI からバック方向に Ts 分戻る。円弧なしの場合の PC 算出と同じ考え方を補正距離で拡張したもの。基礎タンジェント距離手法は道路測量の基本。)

---

### 10.9 SC 座標（グローバル）

`(Xc, Yc)` を TS 基準ローカルから世界座標へ回転・平行移動。左カーブなら +Y、右カーブなら -Y 側。

```ini
SC_local = ( Xc, sgn * Yc )

# 回転 (Az_in) ＋ 平行移動
SC.x = TS.x + SC_local.x * cos(Az_in) - SC_local.y * sin(Az_in)
SC.y = TS.y + SC_local.x * sin(Az_in) + SC_local.y * cos(Az_in)
```

（スパイラルローカル→世界系変換は各スパイラル計算手順の基本。)

---

### 10.10 SC 接線角 & 円弧中心

スパイラル終点 SC の接線角は進入角からスパイラル角だけ回転：

```ini
Az_SC = Az_in + sgn * th_s
```

円弧中心は SC から半径 R 分、接線左側（左カーブ）または右側（右カーブ）へ法線方向に移動：

```ini
nx = -sin(Az_SC)
ny =  cos(Az_SC)
Cx = SC.x + sgn * R * nx
Cy = SC.y + sgn * R * ny
```

円弧中心位置の考え方（スパイラルが円弧に到達した時点で曲率=1/R）および「スパイラルはクロソイド定義に従う」が設計ガイドで述べられています。

---

### 10.11 CS 座標（円弧終点）

円弧中央角 `defl_c` を円の中心まわりに回転して求めます。向きは `sgn` で決定。

```ini
arcAng = sgn * defl_c
CS.x = Cx + R * cos(atan2(SC.y-Cy, SC.x-Cx) + arcAng)
CS.y = Cy + R * sin(atan2(SC.y-Cy, SC.x-Cx) + arcAng)
```

（円弧の任意角位置算出は基本円弧幾何。円弧中央角は §10.4 で定義した残余角。)

---

### 10.12 ST 座標（出口スパイラル終点）

出口スパイラル長は入口と同じ `Ls`（対称仮定）。出口側ローカルで `(Xc, Yc)` を再利用（ただし Yc 符号逆）し、CS を原点・出口円弧接線方向 `Az_out - sgn*th_s` で回転して配置するか、**対称性利用で以下の簡単手**：

1.  出口スパイラル開始角（CS 時点接線）  
    `Az_CS = Az_SC + sgn * defl_c`
    
2.  出口ローカル `(Xc, Yc)` を ST = CS + 回転(Az\_CS, (Xc, -sgn\*Yc)) で変換。
    

出口スパイラル終点 ST の接線角が `Az_out` になる（対称性が成り立てば）。設計資料は入口・出口スパイラルは幾何的に同一（対称）と明示しています。

---

### 10.13 出口方位チェック

浮動小数誤差などで `Az_out` とズレることがあるので、許容角差（例 1e-6 rad）を超えたら `Ls` を微調整して再計算、または最終セグメントを直線補間。現場計算でもスパイラル点は座標計算で微調整可能です。

---

## 11\. スパイラル点列の生成（描画や出力用サンプリング）

### 11.1 数値積分（線形曲率モデル）

スパイラル区間で距離パラメータ `s` (0..Ls) に対し曲率を線形に増加：

```bash
k(s) = (s / Ls) * (1 / R)    # 0→1/R
```

ステップ幅 `ds = Ls / n`。逐次積分：

```makefile
theta += k(s_mid) * ds
x += cos(theta) * ds
y += sin(theta) * ds
```

これでクロソイドを十分近似できます（描画や座標出力に実務的）。スパイラル点を微小デルタで求める手順は設計・測量解説でも推奨されています。

### 11.2 高精度スパイラル座標計算

実装では§10.5で定義したXc/Yc計算式（7次近似）を基礎として、数値積分による高精度なスパイラル点列を生成します。各サンプリング点で曲率を線形補間し、座標を逐次積分することで理論値に近い滑らかなクロソイドを実現しています。

### 11.3 最適化と実装上の注意

- **分割数の調整**: 描画品質と計算速度のバランスを考慮してsteps数を設定
- **角度正規化**: 累積角度誤差を防ぐため定期的な正規化処理を実装
- **数値安定性**: 極小スパイラル角での計算精度を保つためのガード処理

---

## 12\. 実装における高度な機能

### 12.1 線上点挿入とプレビュー機能

実装では、既存の曲線上にマウスカーソルをホバーした際に、新しい制御点の挿入位置をリアルタイムでプレビューできます：

- **線形補間による滑らかな挿入**: 線分上の任意の点で制御点を挿入
- **視覚的フィードバック**: ホバー中の挿入点をリアルタイム表示
- **制御点回避**: 既存制御点近傍では挿入プレビューを非表示

### 12.2 統一エラーハンドリング

全ての計算処理で統一されたエラー処理を実装：

```javascript
// エラーコード定数で分類
ERROR_CODES = {
  INVALID_INPUT: '入力検証エラー',
  CALCULATION_ERROR: '計算エラー', 
  TANGENT_LENGTH_EXCEEDED: 'タンジェント長超過',
  CONVERGENCE_ERROR: '数値収束エラー'
}
```

### 12.3 デバッグとログ機能

計算過程の詳細な記録とパフォーマンス測定：

- **カテゴリ別ログ**: 曲線計算、描画、パフォーマンス別に分類
- **詳細デバッグ情報**: 各計算ステップの中間値を記録
- **パフォーマンス計測**: 処理時間の詳細測定

### 12.4 自動パラメータ調整

設計制約に応じたスパイラルパラメータの自動調整：

- **角度制限チェック**: `defl_c >= 0` を維持するスパイラル長調整
- **タンジェント余長チェック**: 区間長に収まるよう自動スケーリング
- **段階的フォールバック**: スパイラル→単純円弧→直線の順で代替

---

## 13\. 出力エレメント表現（データ構造案）

各折れ点 i から生成される 3 要素（入口スパイラル・円弧・出口スパイラル）を配列化して保持すると再描画・エクスポートが容易。

```yaml
curve_i = {
  spiral_in:  {start: TS,  len: Ls, R_end: R[i],   dir: sgn[i]},
  arc:        {start: SC,  radius: R[i], ang: sgn[i]*defl_c, len: R[i]*defl_c_abs},
  spiral_out: {start: CS,  len: Ls, R_start: R[i], dir: sgn[i]}
}
```

道路線形は「タンジェント・円弧・スパイラルの連続列」で表すのが一般的です。

---

## 14\. 多点（複数 PI）への拡張

### 14.1 基本考え方

ある区間 `P[i] → P[i+1]` は「前カーブ i の出口 ST\_i」から「次カーブ i+1 の入口 TS\_(i+1)」までの **直線余長** を提供します。両側カーブに必要なタンジェント距離の合計が区間長を超えると、スパイラルが入りきりません。設計ではスパイラル長や半径を調整して収めます。

### 14.2 タンジェント余長チェック

各カーブで計算した `Ts_out[i]`（PI→ST）と `Ts_in[i+1]`（次 PI→TS）を取り、区間長 `D = dist(P[i], P[i+1])` と比較：

```lua
need = Ts_out[i] + Ts_in[i+1]
if need > D:
    scale = D / need
    Ls[i]   *= scale
    Ls[i+1] *= scale
    recompute (th_s, defl_c, Ts...) for both
    repeat until all fit
```

現場計算では座標法でスパイラルを「切り詰め」たり円弧で代替することが行われます。測量マニュアルは座標値を使った配置（COGO）でスパイラルを扱えることを示しています。

### 14.3 全体アルゴリズム（概要）

1.  角度前計算（`Az`, `defl`, `sgn`）。
    
2.  各 PI で適用半径 `R[i]` を読み込む（未指定=直線）。
    
3.  `Ls[i]` 自動推定。
    
4.  必要タンジェント長を計算（§10.7）。
    
5.  余長不足があればスケーリング調整（複数回）。
    
6.  調整後、各 PI で TS/SC/Cs/ST を算出。
    
7.  要素列を組み立て（直線区間は ST\_i → TS\_(i+1)）。
    
8.  描画・出力。
    

このように「各折れ点で独立に計算し、タンジェントで整合させる」方式は多エレメント線形の一般的ワークフローと整合します。

---

## 15\. 各折れ点で半径を変える（個別 R 指定）

-   配列 `R[i]` に折れ点ごとの半径を設定。
    
-   半径が大きい（ゆるいカーブ）場合：スパイラル角は小さくなる → 円弧長が増える。
    
-   半径が小さい（きついカーブ）場合：スパイラル角に対して円弧が短くなる → タンジェント要求が増える。
    

複合・逆カーブ・不等半径の扱いは設計資料で取り上げられており、各カーブ要素を組み合わせる設計が一般的です。

---

## 16\. エラー条件とフォールバック戦略

| 状況 | 対応 | 備考 |
| --- | --- | --- |
| absDef ≈ 0（ほぼまっすぐ） | カーブ生成せず直線で返す |  |
| R <= 0 | 入力無効 → カーブ生成スキップ |  |
| Ls > R \* absDef | Ls を自動短縮（defl\_c>=0維持） | §10.4 式 |
| PI→TS/ ST が区間に収まらない | Ls スケールダウン。限界ならスパイラル省略し単純円弧。 | 座標配置で短タンジェント時の調整は実務で発生 |
| 数値反復収束不可 | 単純円弧（スパイラルなし）へフォールバック | 単純円弧式は安定 |

---

## 17\. A1 / R / A2 入力との対応

歴史的なツールでは「A1, R, A2」（入口方位角・半径・出口方位角）で 1 本のカーブを定義する形式があります。現在仕様では座標列を入力するため、各 PI で自動的に以下を取得できます：

```ini
A1 = Az_in
A2 = Az_out
R  = R[i]       # ユーザー指定
```

入出方位（ベアリング）の差から中央角（折れ角）を求めてカーブ要素計算を進める点は設計ガイドの基本です。

---

## 18\. 単位・角度変換メモ

実務資料は「度」「度曲率（DC）」「100 ft arc」など混在します。計算では内部をすべて SI（m）・ラジアンで統一すると安全です。

変換例：

```ini
deg = rad * 180 / PI
rad = deg * PI / 180
```

度ベースの公式（例: theta\_s = Ls\*DC/200）をラジアンに直すと §10.3 の式になります（DC=100 ft 弧 定義等は資料参照）。

---

## 19\. 用語対応表（資料表記とのマッピング）

| 本仕様 | 資料表記例 | 説明 |
| --- | --- | --- |
| `Pi` | PI | 折れ点（交点） |
| `Ts` | TS | Tangent → Spiral 開始距離 |
| `SC` | SC | Spiral → Circular |
| `CS` | CS | Circular → Spiral |
| `ST` | ST | Spiral 終→Tangent |
| `th_s` | theta\_s | スパイラル角 |
| `defl` | Delta (I) | 折れ角 / 全中央角 |
| `defl_c` | Delta\_c | スパイラル挿入後円弧角 |
| `rho` | rho, o | 初期タンジェントからのオフセット |
| `k` | k, Z | シフト補助距離 |

---

## 20\. 計算チェックリスト（設計者用）

-   ✓ 全ポイントが有効数値か検証。
    
-   ✓ 角度正規化（-pi..+pi）。
    
-   ✓ 左右符号 sgn 確定。
    
-   ✓ R 未指定折れ点はスキップして直線連結。
    
-   ✓ Ls 自動計算→角度制限→余長制限。
    
-   ✓ Ts, TS, SC, C, CS, ST 計算。
    
-   ✓ 連続区間で余長超過チェック＆再スケール。
    
-   ✓ 点列サンプリング（n の粗密）。
    
-   ✓ 出口方位差チェック。
    
-   ✓ エラー時フォールバック（単純円弧/直線）。
    

現場で座標値からスパイラルをレイアウトする場合、計算値を利用してステーション座標を順次設置する手法が測量マニュアルで説明されています。

---

## 21\. 設計ヒント（初心者向け）

-   **まずは単純円弧で表示 → 次にスパイラル ON** の段階的手順にすると違いが理解しやすい。
    
-   半径 R を大きくすると「なだらか」、小さくすると「きゅっ」と曲がる。結果をすぐ確認して体感できると学習に効果的。
    
-   検証時は TS/SC/CS/ST を色付き点で表示すると、式の間違いがすぐわかる。
    
-   余長不足でスパイラルが入り切らない時は、警告表示（例：「区間が短すぎて設計値が入りません。スパイラル短縮しました」）。
    
-   座標を動的に変更できるとインタラクティブ学習になる。
    

スパイラルを入れることで見た目の「角の取れ方」が滑らかになり、視覚的な印象が大きく変わります。

---

## 22\. 参考資料（抜粋）

以下の公開資料に、緩和（スパイラル／クロソイド）付き水平線形の定義・用語・計算式が掲載されています（順不同）。

-   Tennessee Department of Transportation (TDOT), **"Spiral Calculation Guide"** — TS/SC/CS/ST 定義、theta\_s, Delta\_c, Yc, Xc, rho, k, Ts など計算表と手順。[Tennessee State Government](https://www.tn.gov/content/dam/tn/tdot/engineering-production-support/documents/design-standards/additional-resources/Spiral%20Calculation%20Guide.pdf)
    
-   Wyoming Department of Transportation (WYDOT), **Road Design Manual, Section Horizontal Alignment & Superelevation** — 単純円弧式 (T = R tan(Δ/2), etc.) とスパイラル概念。[dot.state.wy.us](https://www.dot.state.wy.us/files/live/sites/wydot/files/shared/Project%20Development/Road%20Design%20Manual_1/3-02%20%20%282014%20DEC%29.pdf)
    
-   Mypdh.engineer, **"Spiral Curves"**（教育コース）— スパイラルの目的、曲率 0→1/R、要素記号、Ts = (R + o)Tan(I/2) + Z など。教育的解説に有用。[Mypdh.engineer](https://mypdh.engineer/lessons/spiral-curves/)
    
-   California Department of Transportation (Caltrans), **Highway Design Manual, Topic 203.8 Spiral Transition** — スパイラルをタンジェントと円弧の遷移に使用、クロソイド定義に整合させることを推奨。[dot.ca.gov](https://dot.ca.gov/-/media/dot-media/programs/design/documents/chp0200-032020.pdf)
    
-   Washington State DOT, **Highway Surveying Manual Chapter 11** — スパイラルの現場設置・座標法・代替測量手法（TS占位/座標計算）。座標ベース計算の参考。[wsdot.wa.gov](https://wsdot.wa.gov/publications/manuals/fulltext/m22-97/chapter11.pdf)
    
-   CED Engineering, **Roadway Horizontal Alignment (Course)** — 水平線形はタンジェント・円弧・スパイラルの組合せで構成されること、設計原則。[www.cedengineering.com](https://www.cedengineering.com/userfiles/C04-034%20-%20Roadway%20Horizontal%20Alignment%20-%20US.pdf)
    

---

# （付録）最小ワークフロー図（文章で表現）

```css
ユーザーが点列 P0..Pn を入力
  ↓
折れ角 defl[i] と左右 sgn[i] を計算
  ↓
各折れ点で半径 R[i] を読み込み
  ↓
Ls[i] 自動推定（経験則や角度比例）
  ↓
th_s, defl_c, Yc, Xc, rho, k → Ts
  ↓
TS, SC, 円弧中心, CS, ST を座標算出
  ↓
余長チェック (ST_i to TS_(i+1)) → 必要に応じ Ls 調整再計算
  ↓
スパイラル・円弧・スパイラル・直線を点列に展開
  ↓
描画 / データ出力 (DXF, SVG, etc.)
```
